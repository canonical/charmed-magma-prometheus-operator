# Copyright 2022 Canonical Ltd.
# See LICENSE file for licensing details.

name: prometheus-with-configurer
summary: Prometheus with additional configurer container
description: |
  This charm is a fork of the prometheus-k8s-operator charm.
  Prometheus is an open source monitoring solution. Prometheus supports aggregating high 
  dimensional data and exposes a powerful query language PromQL. This charm deploys and operates 
  Prometheus on Kubernetes clusters. Prometheus can raise alerts through a relation with the 
  Alertmanager charm. 
  In addition to the bare Prometheus, this charm includes prometheus-configurer container providing
  an HTTP API for managing alerting rules. API documentation is available at
  https://github.com/facebookarchive/prometheus-configmanager/blob/main/prometheus/docs/swagger-v1.yml.

containers:
  prometheus:
    resource: prometheus-image
    mounts:
      - storage: database
        location: /var/lib/prometheus
      - storage: rules
        location: /etc/prometheus/rules
  prometheus-configurer:
    resource: prometheus-configurer-image
    mounts:
      - storage: rules
        location: /etc/prometheus/rules

provides:
  self-metrics-endpoint:
    interface: prometheus_scrape
  grafana-source:
    interface: grafana_datasource
  grafana-dashboard:
    interface: grafana_dashboard
  receive-remote-write:
    interface: prometheus_remote_write

requires:
  metrics-endpoint:
    interface: prometheus_scrape
  alertmanager:
    interface: alertmanager_dispatch
  ingress:
    interface: ingress_per_unit
    limit: 1

peers:
  prometheus-peers:
    interface: prometheus_peers

storage:
  database:
    type: filesystem
  rules:
    location: /etc/prometheus/rules
    type: filesystem

resources:
  prometheus-image:
    type: oci-image
    description: Container image for Prometheus
    upstream-source: docker.io/ubuntu/prometheus:2.33-22.04_beta
  prometheus-configurer-image:
    type: oci-image
    description: Container image for Prometheus Configurer
    upstream-source: docker.io/facebookincubator/prometheus-configurer:1.0.4
